---
author: Bokmark Ma
title: "Binder 个人总结"
date: 2022-11-09T18:30:06+08:00
draft: true
description: binder 个人总结
categories:
    - Android
tags:
    - Android
    - Binder
---

# Binder 个人总结

## 为什么是binder，以及binder是什么？

Linux 将内存空间分为用户空间和内核空间。  
内核空间只有内核才可以操作。当用户进程需要操作内核时，通过ioctl调用内核函数来实现。  
为什么要这么做？  
只有这样当用户进程崩溃的时候不会连累内核进程。这也就是进程隔离。  

Android 基于linux的os。Android 每个APP就是一个或者多个进程。那么Android就需要一些跨进程手段。  
Linux的一些跨进程手段在android中也是可用的，比如Socket、管道、共享内存等方式呢？  
那为什么Android采用了Binder 这种跨进程手段，而不是Socket、管道、共享内存等方式呢？  

所以我们需要从安全性和效率两方面来比较Binder 和 Socket、管道、共享内存之前的区别。

### 管道
管道本质上就是打开一个文件，一端只读，一端只写。

管道分为两种，匿名管道，和命名管道。  
匿名管道自在父子进程之间使用，子进程通过fork父进程来获取到匿名管道，这种方式不通用，也就无所谓安全性。  
命名管道相当于创建了一个文件，任何进程都可以获取这个管道文件的文件描述符来进行读写，安全性几乎没有。

而文件的读写，都需要数据在内核态和用户态之间传递，效率为需要两次拷贝。

### 共享内存
两个进程共同映射同一个物理地址，来完成两个进程之间的通信。  

效率很高，但是只要知道具体的内存地址，任何进程都可以来映射这块区域。

### socket
c/s 架构，效率与管道相同，是打开一个文件或者端口来实现的。

安全性方面，只要知道server端的ip和端口就可以连接。


### binder
c/s 架构。在server端通过mmap 将用户空间的一块地址和内核空间的一块地址影视在一起。client 端发送数据，将数据拷贝到内核空间的地址，服务器不再需要做一个内核空间到用户空间的拷贝。  

### binder与其他三个的比较

| 待比较内容    | 效率（内核空间与用户空间之间的拷贝） | 安全性  | 使用的难易程度 |
| :----       | :----  | :---- |  :---- |
| Socket      | 两次拷贝 | 通过ip和端口即可连接，无法知道连接的用户是谁 | 复杂，需要完整的套接字连接流程 |
| 管道         | 两次拷贝 | 命名管道，自需要知道管道文件即可连接 | 简单，但是匿名管道无法通用 |
| 共享内存      | 无需拷贝 | 知道对应的地址即可映射 |  复杂，需要处理垮进程的互斥 |
| Binder      | 一次拷贝 | 需要相应的uid，可以知道连接的客户端是谁 |  简单，rpc调用 | 

## Binder原理

binder 是基于 c\s 架构的一个ipc进程间调用机制。其中从上到下共涉及到四层的内容。第一层：java，第二层：jni，第三层：c++，第四层，kernel。
java层：包括Aidl，Ibinder等Java类，最终调用jni到binder_open等方法

